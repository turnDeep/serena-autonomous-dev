# GPUå¯¾å¿œã®è‡ªå¾‹å‹é–‹ç™ºç’°å¢ƒ
# CUDA 13.0 + cuDNN + Ubuntu 22.04 LTS (æœ€æ–°å®‰å®šç‰ˆ)
FROM nvidia/cuda:13.0.0-cudnn-devel-ubuntu22.04

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Tokyo
ENV PYTHONUNBUFFERED=1
ENV NODE_VERSION=20
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# CUDAã®è¨­å®š
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV XLA_FLAGS=--xla_gpu_cuda_data_dir=/usr/local/cuda

# Serena-MCPè¨­å®š
ENV SERENA_AUTO_LEVEL=5
ENV SERENA_CONTEXT=ide-assistant

# åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    # åŸºæœ¬ãƒ„ãƒ¼ãƒ«
    curl \
    wget \
    git \
    vim \
    nano \
    htop \
    tmux \
    # ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«
    build-essential \
    cmake \
    pkg-config \
    # Pythoné–¢é€£
    python3 \
    python3-pip \
    python3-dev \
    python3-venv \
    # ã‚·ã‚¹ãƒ†ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    libssl-dev \
    libffi-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libncurses5-dev \
    libncursesw5-dev \
    libgdbm-dev \
    libnss3-dev \
    libxml2-dev \
    libxmlsec1-dev \
    # GPU/MLé–¢é€£
    nvidia-cuda-toolkit \
    libnccl2 \
    libnccl-dev \
    # ãã®ä»–
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Node.jsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆNodeSourceçµŒç”±ï¼‰
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆCUDA 13.0å¯¾å¿œç‰ˆï¼‰
RUN pip3 install --upgrade pip setuptools wheel \
    && pip3 install \
    numpy \
    pandas \
    scipy \
    matplotlib \
    jupyter \
    ipykernel \
    torch \
    torchvision \
    torchaudio \
    tensorflow \
    transformers \
    accelerate \
    datasets \
    tokenizers \
    sentencepiece

# uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆSerena-MCPç”¨ï¼‰
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:${PATH}"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm install -g \
    @anthropic-ai/claude-code \
    @google/gemini-cli \
    typescript \
    ts-node \
    nodemon \
    prettier \
    eslint

# Serena-MCPã®ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
RUN uvx --from git+https://github.com/oraios/serena serena --version || true

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
WORKDIR /workspaces

# å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
RUN mkdir -p \
    /root/.serena \
    /root/.gemini \
    /root/.claude/commands \
    /root/PDF \
    /tmp/serena

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
COPY --chown=root:root .serena/serena_config.yml* /root/.serena/
COPY --chown=root:root .gemini/settings.json* /root/.gemini/
COPY --chown=root:root .claude/memory.json* /root/.claude/

# Makefileã®ã‚³ãƒ”ãƒ¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
COPY --chown=root:root Makefile* /workspaces/

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# GPUã®ç¢ºèª\n\
echo "ğŸ® Checking GPU availability..."\n\
nvidia-smi || echo "âš ï¸ GPU not available"\n\
\n\
# Serena-MCPã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•\n\
echo "ğŸ¤– Starting Serena-MCP server..."\n\
nohup uvx --from git+https://github.com/oraios/serena serena start-mcp-server \\\n\
    --transport sse \\\n\
    --port 9121 \\\n\
    --context ide-assistant \\\n\
    --auto-level 5 \\\n\
    > /tmp/serena/server.log 2>&1 &\n\
\n\
echo "âœ… Serena-MCP server started on http://localhost:9121/sse"\n\
echo "ğŸ“ Logs available at /tmp/serena/server.log"\n\
\n\
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰\n\
if [ -f "/workspaces/Makefile" ]; then\n\
    echo "ğŸ“¦ Running project setup..."\n\
    cd /workspaces && make setup || true\n\
fi\n\
\n\
# ã‚·ã‚§ãƒ«ã®èµ·å‹•\n\
exec "$@"\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:9121/health || exit 1

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 9121 3000 8080 5173 8888

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]