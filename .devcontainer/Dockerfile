# GPUå¯¾å¿œã®è‡ªå¾‹å‹é–‹ç™ºç’°å¢ƒ
# CUDA 13.0 + cuDNN + Ubuntu 22.04 LTS (æœ€æ–°å®‰å®šç‰ˆ)
FROM nvidia/cuda:13.0.0-cudnn-devel-ubuntu22.04

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Tokyo
ENV PYTHONUNBUFFERED=1
ENV NODE_VERSION=20
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# CUDAã®è¨­å®š
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV XLA_FLAGS=--xla_gpu_cuda_data_dir=/usr/local/cuda

# Serena-MCPè¨­å®š
ENV SERENA_AUTO_LEVEL=5
ENV SERENA_CONTEXT=ide-assistant

# åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    # åŸºæœ¬ãƒ„ãƒ¼ãƒ«
    curl \
    wget \
    git \
    vim \
    nano \
    htop \
    tmux \
    # ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«
    build-essential \
    cmake \
    pkg-config \
    # Pythoné–¢é€£
    python3 \
    python3-pip \
    python3-dev \
    python3-venv \
    # ã‚·ã‚¹ãƒ†ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    libssl-dev \
    libffi-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libncurses5-dev \
    libncursesw5-dev \
    libgdbm-dev \
    libnss3-dev \
    libxml2-dev \
    libxmlsec1-dev \
    # GPU/MLé–¢é€£ï¼ˆnvidia-cuda-toolkitã¯å‰Šé™¤ - ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¦ã„ã‚‹ï¼‰
    libnccl2 \
    libnccl-dev \
    # ãã®ä»–
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Node.jsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆNodeSourceçµŒç”±ï¼‰
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

# npmã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã‚’ä¿®æ­£
RUN mkdir -p /usr/lib/node_modules \
    && chmod -R 755 /usr/lib/node_modules

# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ï¼‰
RUN pip3 install --upgrade pip setuptools wheel \
    && pip3 install \
    numpy \
    pandas \
    scipy \
    matplotlib \
    jupyter \
    ipykernel

# uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆSerena-MCPç”¨ï¼‰
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
WORKDIR /workspaces

# å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
RUN mkdir -p \
    /root/.serena \
    /root/.gemini \
    /root/.claude/commands \
    /root/PDF \
    /tmp/serena

# ã‚°ãƒ­ãƒ¼ãƒãƒ«npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆ1ã¤ãšã¤ç¢ºå®Ÿã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
RUN echo "Installing Claude Code..." && \
    npm install -g @anthropic-ai/claude-code && \
    echo "Claude Code installed successfully" && \
    which claude || echo "Warning: claude command not found in PATH"

RUN echo "Installing Gemini CLI..." && \
    npm install -g @google/gemini-cli && \
    echo "Gemini CLI installed successfully" && \
    which gemini || echo "Warning: gemini command not found in PATH"

# è¿½åŠ ã®é–‹ç™ºãƒ„ãƒ¼ãƒ«
RUN npm install -g \
    typescript \
    ts-node \
    nodemon \
    prettier \
    eslint

# ãƒ‘ã‚¹ã®ç¢ºèªã¨ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®ä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
RUN echo "Checking installed commands..." && \
    ls -la /usr/lib/node_modules/@anthropic-ai/claude-code/bin/ 2>/dev/null || true && \
    ls -la /usr/lib/node_modules/@google/gemini-cli/bin/ 2>/dev/null || true && \
    echo "PATH: $PATH"

# npmã®ã‚°ãƒ­ãƒ¼ãƒãƒ«binãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’PATHã«è¿½åŠ 
ENV PATH="/usr/bin:${PATH}"

# Serena-MCPã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ãƒ—ãƒ¬ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ï¼‰
RUN echo "Pre-loading Serena-MCP..." && \
    (timeout 10 uvx --from git+https://github.com/oraios/serena serena --version || true) && \
    echo "Serena-MCP pre-load complete"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ï¼ˆæ¡ä»¶ä»˜ãã‚³ãƒ”ãƒ¼ã®ãŸã‚ã€RUNã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ï¼‰
# å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼
RUN if [ -f .serena/serena_config.yml ]; then \
        cp .serena/serena_config.yml /root/.serena/; \
    fi && \
    if [ -f .serena/serena_config.yaml ]; then \
        cp .serena/serena_config.yaml /root/.serena/; \
    fi

RUN if [ -f .gemini/settings.json ]; then \
        cp .gemini/settings.json /root/.gemini/; \
    fi

RUN if [ -f .claude/memory.json ]; then \
        cp .claude/memory.json /root/.claude/; \
    fi

# ã‚³ãƒãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
# æ³¨ï¼šãƒ“ãƒ«ãƒ‰ã‚’æˆåŠŸã•ã›ã‚‹ã«ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« .claude/commands/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆç©ºã§ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼‰ã€‚
COPY ../.claude/commands/ /tmp/claude-commands/
RUN if [ -d /tmp/claude-commands ]; then \
        cp -r /tmp/claude-commands/* /root/.claude/commands/ 2>/dev/null || true; \
        rm -rf /tmp/claude-commands; \
    fi

# Makefileã®ã‚³ãƒ”ãƒ¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
# æ³¨ï¼šãƒ“ãƒ«ãƒ‰ã‚’æˆåŠŸã•ã›ã‚‹ã«ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« Makefile ãŒå­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
COPY ../Makefile /workspaces/

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "=== Development Environment Starting ==="\n\
\n\
# GPUã®ç¢ºèª\n\
echo "ğŸ® Checking GPU availability..."\n\
nvidia-smi --query-gpu=name,memory.total --format=csv,noheader || echo "âš ï¸ GPU not available"\n\
\n\
# ã‚³ãƒãƒ³ãƒ‰ã®ç¢ºèª\n\
echo ""\n\
echo "ğŸ“¦ Checking installed tools..."\n\
echo -n "  Claude Code: "\n\
if command -v claude &> /dev/null; then\n\
    claude --version 2>/dev/null || echo "installed (version check failed)"\n\
else\n\
    echo "âŒ NOT FOUND - Run: npm install -g @anthropic-ai/claude-code"\n\
fi\n\
\n\
echo -n "  Gemini CLI: "\n\
if command -v gemini &> /dev/null; then\n\
    gemini --version 2>/dev/null || echo "installed (version check failed)"\n\
else\n\
    echo "âŒ NOT FOUND - Run: npm install -g @google/gemini-cli"\n\
fi\n\
\n\
echo -n "  Serena-MCP: "\n\
if command -v uvx &> /dev/null; then\n\
    echo "âœ… Available via uvx"\n\
else\n\
    echo "âŒ uvx not found"\n\
fi\n\
\n\
# Serena-MCPã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰\n\
echo ""\n\
echo "ğŸ¤– Starting Serena-MCP server..."\n\
mkdir -p /tmp/serena\n\
nohup uvx --from git+https://github.com/oraios/serena serena start-mcp-server \\\n\
    --transport sse \\\n\
    --port 9121 \\\n\
    --context ide-assistant \\\n\
    --auto-level 5 \\\n\
    > /tmp/serena/server.log 2>&1 &\n\
\n\
echo "âœ… Serena-MCP server starting on http://localhost:9121/sse"\n\
echo "ğŸ“ Logs available at /tmp/serena/server.log"\n\
\n\
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰\n\
if [ -f "/workspaces/Makefile" ]; then\n\
    echo ""\n\
    echo "ğŸ“¦ Running project setup..."\n\
    cd /workspaces && make setup || true\n\
fi\n\
\n\
# ä¸è¶³ã—ã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†…\n\
echo ""\n\
echo "=== Setup Instructions ==="\n\
if ! command -v claude &> /dev/null; then\n\
    echo ""\n\
    echo "âš ï¸ Claude Code is not installed. To install:"\n\
    echo "   npm install -g @anthropic-ai/claude-code"\n\
fi\n\
\n\
if ! command -v gemini &> /dev/null; then\n\
    echo ""\n\
    echo "âš ï¸ Gemini CLI is not installed. To install:"\n\
    echo "   npm install -g @google/gemini-cli"\n\
fi\n\
\n\
echo ""\n\
echo "ğŸ“š After installing, authenticate with:"\n\
echo "   claude  # For Claude Code"\n\
echo "   gemini  # For Gemini CLI"\n\
echo ""\n\
echo "=== Environment Ready ==="\n\
echo ""\n\
\n\
# ã‚·ã‚§ãƒ«ã®èµ·å‹•\n\
exec "$@"\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:9121/health || exit 1

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 9121 3000 8080 5173 8888

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]
